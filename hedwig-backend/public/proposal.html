<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal | Hedwig</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }

        .document-paper {
            font-family: 'Merriweather', serif;
            color: #111827;
            line-height: 1.8;
        }

        .markdown-body h1 {
            font-family: 'Merriweather', serif;
            font-size: 24pt;
            font-weight: 900;
            text-align: center;
            margin-bottom: 1.5em;
            color: #000;
        }

        .markdown-body h2 {
            font-family: 'Merriweather', serif;
            font-size: 14pt;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 2em;
            margin-bottom: 1em;
            color: #000;
            letter-spacing: 0.05em;
        }

        .markdown-body p {
            margin-bottom: 1.2em;
            text-align: justify;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 2em;
            margin-bottom: 1.2em;
        }

        .markdown-body li {
            margin-bottom: 0.5em;
            padding-left: 0.5em;
        }

        .markdown-body strong {
            font-weight: 700;
            color: #000;
        }

        @media print {
            body {
                background: white;
            }

            .no-print {
                display: none !important;
            }

            .document-paper {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>

<body class="min-h-screen pb-32">

    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-50 z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
    </div>

    <div id="error"
        class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-50 text-red-600 px-6 py-3 rounded-full shadow-lg z-50 border border-red-100">
    </div>

    <div class="max-w-[850px] mx-auto my-8 sm:my-12 bg-white shadow-xl min-h-[1100px] p-12 sm:p-20 relative document-paper"
        id="document-container">
        <div id="proposal-content" class="markdown-body hidden"></div>

        <!-- Accept Section -->
        <div id="accept-section" class="hidden mt-12 pt-8 border-t-2 border-gray-200 no-print">
            <div class="text-center space-y-6">
                <h3 class="text-xl font-bold text-gray-900">Ready to Proceed?</h3>
                <p class="text-gray-600">Review the proposal above and accept to move forward</p>

                <button id="accept-btn"
                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-8 rounded-xl transition-all hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                    Accept Proposal
                </button>

                <p class="text-xs text-gray-500">
                    You'll be prompted to connect your wallet
                </p>
            </div>
        </div>

        <!-- Accepted Status -->
        <div id="accepted-section" class="hidden mt-12 pt-8 border-t-2 border-gray-200">
            <div class="bg-green-50 border-2 border-green-200 rounded-xl p-8 text-center space-y-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-green-900">Proposal Accepted!</h3>
                <p class="text-green-700">You have successfully accepted this proposal.</p>
                <div class="text-sm text-gray-600 mt-4">
                    <div>Accepted on: <span id="accepted-date" class="font-semibold"></span></div>
                    <div>Wallet: <span id="accepted-wallet" class="font-mono text-xs"></span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Footer Action Bar -->
    <div
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 flex justify-center items-center shadow-[0_-4px_20px_rgba(0,0,0,0.05)] no-print z-40">
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <button onclick="downloadPDF()" id="download-btn"
                class="bg-gray-900 text-white px-6 py-3 rounded-full font-medium hover:bg-gray-800 transition-all transform hover:scale-105 shadow-lg flex items-center gap-2 text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download PDF
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        let documentId;
        let documentData;
        let provider = null;
        let signer = null;

        async function loadProposal() {
            documentId = window.location.pathname.split('/').pop();

            if (!documentId) {
                showError('No proposal ID provided');
                return;
            }

            try {
                const response = await fetch(`/api/documents/${documentId}/public`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error?.message || 'Failed to load proposal');
                }

                documentData = data.data.document;
                const content = documentData.content?.generated_content || '# No content available';

                document.getElementById('loading').classList.add('hidden');
                const contentDiv = document.getElementById('proposal-content');
                contentDiv.innerHTML = marked.parse(content);
                contentDiv.classList.remove('hidden');

                document.title = `${documentData.title} | Proposal`;

                // Check if already accepted
                if (documentData.status === 'PAID' || documentData.status === 'ACCEPTED') {
                    showAcceptedStatus();
                } else {
                    // Show accept section
                    document.getElementById('accept-section').classList.remove('hidden');
                }

            } catch (error) {
                showError(error.message);
            }
        }

        function showAcceptedStatus() {
            document.getElementById('accept-section').classList.add('hidden');
            document.getElementById('accepted-section').classList.remove('hidden');

            const acceptedDate = new Date(documentData.content?.accepted_at || documentData.updated_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('accepted-date').textContent = acceptedDate;

            if (documentData.content?.accepted_wallet) {
                const wallet = documentData.content.accepted_wallet;
                document.getElementById('accepted-wallet').textContent = `${wallet.substring(0, 6)}...${wallet.substring(wallet.length - 4)}`;
            }
        }

        // Accept button click handler
        document.getElementById('accept-btn').addEventListener('click', async () => {
            const btn = document.getElementById('accept-btn');

            if (!documentId) {
                alert('Proposal not loaded yet. Please wait and try again.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Connecting...';

            try {
                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Please install MetaMask or another Web3 wallet to continue');
                }

                // Request account access
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const walletAddress = await signer.getAddress();

                btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Accepting...';

                // Call backend to accept proposal
                const response = await fetch(`/api/documents/${documentId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ walletAddress })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error?.message || 'Failed to accept proposal');
                }

                // Refresh page to show accepted status
                window.location.reload();

            } catch (error) {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = 'Accept Proposal & Connect Wallet';

                if (error.code === 4001) {
                    alert('Wallet connection rejected');
                } else {
                    alert(error.message || 'Failed to accept proposal');
                }
            }
        });

        async function downloadPDF() {
            const btn = document.getElementById('download-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generating...';

            try {
                const element = document.getElementById('document-container');
                const opt = {
                    margin: [0.5, 0.5],
                    filename: (documentData?.title || 'Proposal') + '.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(element).save();

            } catch (error) {
                console.error('PDF error:', error);
                alert('Failed to download PDF: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        loadProposal();
    </script>
</body>

</html>